#Add screen lock and password 
#https://community.spiceworks.com/scripts/show/4460-change-screen-timeout

$Host.UI.RawUI.WindowTitle = "Change Screen Timeout"
# Create a new "drive" with the registry directory HKEY_USERS; this allows the script to access other users settings.
New-PSDrive -PSProvider Registry -Name HKU -Root HKEY_USERS
# Gathers all the HKEY_USERS directories (SIDs, mostly)
$regarray = Get-ChildItem -Directory -Name "HKU:"
Clear-Host
# Calculates the seconds from minutes because, if you can help it, WHY WOULD YOU DO THE MATH YOURSELF?!
$minutes = Read-Host -Prompt "Enter the number of minutes before timeout"
$seconds = 60 * $minutes
# The function that takes each registry path and either creates or changes screensaver properties
Function CreateRegValues($regpath) {
    New-ItemProperty -Path $regpath -Name "ScreenSaveActive" -Value 1 -PropertyType String -Force
    New-ItemProperty -Path $regpath -Name "ScreenSaverIsSecure" -Value 1 -PropertyType String -Force
    New-ItemProperty -Path $regpath -Name "ScreenSaveTimeOut" -Value $seconds -PropertyType String -Force
    New-ItemProperty -Path $regpath -Name "SCRNSAVE.EXE" -Value "C:\Windows\system32\ssText3d.scr" -PropertyType String -Force
}
# This function tests registry paths to make sure to create them along the way if they don't already exist
Function TestRegValues($regpath) {
    if (-not (Test-Path($regpath + "\Control Panel"))) {
        New-Item -Path $regpath -Name "Control Panel"
    }
    $global:regpath += "\Control Panel"
    if (-not (Test-Path ($regpath + "\Desktop"))) {
        New-Item -Path $regpath -Name "Desktop"
    }
    $regpath += "\Desktop"
    CreateRegValues($regpath)
}
# These edit the LOCAL_MACHINE settings and CURRENT_USER settings; HKU\[current_user_SID] doesn't actually touch HKCU...
CreateRegValues("HKLM:\Software\Policies\Microsoft\Windows\Control Panel\Desktop")
CreateRegValues("HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop")
CreateRegValues("HKCU:\Control Panel\Desktop")
# This goes through all the user accounts in HKEY_USERS
foreach ($regitem in $regarray) {
    $regpath = "HKU:\" + $regitem
    TestRegValues($regpath)
    $regpath = "HKU:\" + $regitem + "\Software\Policies\Microsoft\Windows"
    TestRegValues($regpath)
}
# Change login auto-disconnect
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\services\LanmanServer\Parameters" -Name "autodisconnect" -Value $minutes
Write-Host "Finished!"
$minutes = Read-Host -Prompt "Press enter to exit"